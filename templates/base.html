<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}NewTon — AI Powered Scheduler{% endblock %}</title>

  <!-- PWA -->
  <meta name="theme-color" content="#0b84ff" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/static/icons/icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png" />
  <link rel="stylesheet" href="/static/css/app.css" />

  <style>
    :root {
      --brand:#0b84ff; --bg:#ffffff; --ink:#0c1117; --muted:#6b7280;
      --surface:#f6f7fb; --radius:16px;
    }
    body { background: var(--surface); color: var(--ink); margin:0; }
    .appbar {
      position: sticky; top: 0; z-index: 40;
      display:flex; align-items:center; gap:.75rem;
      padding:.75rem 1rem; background:var(--bg); box-shadow:0 1px 8px rgba(0,0,0,.06);
    }
    .brand { display:flex; align-items:center; gap:.5rem; font-weight:800; letter-spacing:.2px; }
    .brand .dot { width:10px; height:10px; border-radius:999px; background:var(--brand); display:inline-block; }
    .brand small { color:var(--muted); font-weight:600; }
    .spacer { flex:1; }
    .btn, .menu a {
      display:inline-flex; align-items:center; justify-content:center;
      padding:.65rem 1rem; border-radius:.75rem; border:1px solid #e5e7eb; background:#fff;
      text-decoration:none; color:inherit; font-weight:600;
    }
    .btn:active { transform: translateY(1px); }
    .ghost { background:transparent; border:1px solid #e5e7eb; }
    .primary { background:var(--brand); color:#fff; border-color:transparent; }

    .container { max-width: 960px; margin: 0 auto; padding: 1rem; }
    main { margin-top: .5rem; }

    /* Backdrop stays constant, no blur/tint shift */
    .backdrop {
    position: fixed; inset: 0;
    background: rgba(0,0,0,.55);
    display: none; z-index: 50;
    }
    .backdrop.show { display:block; }

    /* Drawer: solid dark surface so color never changes while scrolling */
    .drawer {
    position: fixed; inset: 0 auto 0 0; width: 84%; max-width: 320px;
    background:#0b1020;           /* solid color */
    color:#e5e7eb;                 /* slate-200 text */
    box-shadow: 2px 0 22px rgba(0,0,0,.35);
    transform: translateX(-100%); transition: transform .25s ease; z-index: 60;
    display:flex; flex-direction:column; padding:1rem;
    -webkit-backdrop-filter: none; backdrop-filter: none;
    }

    /* Drawer buttons readable on dark bg */
    .menu .btn {
    background: #0f172a;            /* slate-900 */
    border-color: rgba(255,255,255,.08);
    color: #e5e7eb;
    }
    .menu .btn:active { transform: translateY(1px); }
    .drawer.show { transform: translateX(0); }

    .menu { display:flex; flex-direction:column; gap:.5rem; }
    .menu a { text-align:left; }

    .modal { position: fixed; inset: 0; display: none; place-items: center; z-index: 70; background: rgba(0,0,0,.4); }
    .modal.show { display: grid; }
    .card { width:min(92vw, 420px); background:#fff; border-radius: var(--radius); box-shadow:0 10px 30px rgba(0,0,0,.15); padding:1.25rem; }
    .card h2 { margin:.25rem 0 .75rem; }
    .field { display:flex; gap:.5rem; }
    .field input { flex:1; padding:.7rem .9rem; border:1px solid #e5e7eb; border-radius:.6rem; outline:none; }
    .note { font-size:.9rem; color: var(--muted); margin-top:.5rem; }

    .motivation {
      background: linear-gradient(120deg, rgba(11,132,255,.1), rgba(11,132,255,.05));
      border:1px dashed rgba(11,132,255,.35);
      padding:1rem; border-radius:var(--radius); margin: .75rem 0 1rem;
    }

    @media (max-width: 768px) {
      .actions { display:none; }
      .fab { position: fixed; right: 16px; bottom: 16px; z-index: 40; }
    }
  </style>
  {% block head_extra %}{% endblock %}
</head>
<body>
  <!-- App Bar -->
  <header class="appbar">
    <button id="menuBtn" class="btn ghost" aria-label="Open menu">☰</button>
    <div class="brand">
      <span class="dot"></span>
      <span>NewTon</span>
      <small>— AI Scheduler</small>
    </div>
    <div class="spacer"></div>
    <div class="actions">
      <a class="btn ghost" href="/">Home</a>
      <a class="btn" href="/schedule">Monthly Schedule</a>
      <a class="btn" href="/daily">Daily Schedule</a>
      <button id="installBtn" class="btn primary" hidden>Install App</button>
    </div>
  </header>

  <!-- Slide-in Drawer -->
  <div id="backdrop" class="backdrop"></div>
  <nav id="drawer" class="drawer" aria-label="Main">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom: .5rem;">
      <div class="brand"><span class="dot"></span><span>NewTon</span></div>
      <button id="closeDrawer" class="btn ghost" aria-label="Close menu">✕</button>
    </div>
    <div class="menu">
      <a href="/" class="btn">Home</a>
      <a href="/schedule" class="btn">Monthly Schedule</a>
      <a href="/daily" class="btn">Daily Schedule</a>
      <button id="installBtn2" class="btn primary" hidden>Install App</button>
    </div>
  </nav>

  <!-- Code Gate Modal -->
  <div id="gateModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="gateTitle">
    <div class="card">
      <h2 id="gateTitle">Enter Access Code</h2>
      <p class="note">Unlock NewTon on this device.</p>
      <div class="field">
        <input id="codeInput" type="password" placeholder="Access code" autocomplete="one-time-code" />
        <button id="codeSubmit" class="btn primary">Enter</button>
      </div>
      <p id="gateError" class="note" style="color:#b91c1c; display:none;">Incorrect code. Try again.</p>
    </div>
  </div>

  <!-- Main -->
  <div class="container">
    <section id="motivation" class="motivation" style="display:none;">
      <strong id="motivationLine">Consistency beats intensity. Show up today.</strong>
    </section>

    {% block content %}{% endblock %}
  </div>


  <script src="/static/js/pwa.js"></script>
  <script>
    // Drawer
    const drawer = document.getElementById('drawer');
    const backdrop = document.getElementById('backdrop');
    const menuBtn = document.getElementById('menuBtn');
    const closeDrawer = document.getElementById('closeDrawer');
    const toggleDrawer = (show) => {
      drawer.classList.toggle('show', show);
      backdrop.classList.toggle('show', show);
    };
    menuBtn?.addEventListener('click', () => toggleDrawer(true));
    closeDrawer?.addEventListener('click', () => toggleDrawer(false));
    backdrop?.addEventListener('click', () => toggleDrawer(false));

    // Install buttons
    let deferredPromptEvent = null;
    const installButtons = [document.getElementById('installBtn'), document.getElementById('installBtn2'), document.getElementById('installBtn3')].filter(Boolean);
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPromptEvent = e;
      installButtons.forEach(b => b.hidden = false);
    });
    installButtons.forEach(btn => btn.addEventListener('click', async () => {
      if (!deferredPromptEvent) return;
      deferredPromptEvent.prompt();
      await deferredPromptEvent.userChoice;
      deferredPromptEvent = null;
      installButtons.forEach(b => b.hidden = true);
    }));

    // Code Gate
    const ACCESS_CODE = "{{ access_code|default('1234') }}";
    const GATE_KEY = 'newton_gate_ok_v1';

    const gateModal = document.getElementById('gateModal');
    const codeInput = document.getElementById('codeInput');
    const codeSubmit = document.getElementById('codeSubmit');
    const gateError = document.getElementById('gateError');
    const motivation = document.getElementById('motivation');
    const motivationLine = document.getElementById('motivationLine');

    const LINES = [
      "Consistency compounds — schedule it, ship it.",
      "Tiny slots daily beat marathon sessions.",
      "Plan. Act. Review. Repeat.",
      "Your calendar is your strategy.",
      "NewTon tip: protect your focus blocks."
    ];

    const pickLine = () => motivationLine.textContent = LINES[Math.floor(Math.random()*LINES.length)];

    function showGateIfNeeded() {
      const ok = localStorage.getItem(GATE_KEY);
      if (ok === 'yes') { motivation.style.display = 'block'; pickLine(); return; }
      gateModal.classList.add('show');
      setTimeout(() => codeInput?.focus(), 50);
    }

    function tryUnlock() {
      const val = (codeInput?.value || "").trim();
      if (val === ACCESS_CODE) {
        localStorage.setItem(GATE_KEY, 'yes');
        gateModal.classList.remove('show');
        gateError.style.display = 'none';
        motivation.style.display = 'block';
        pickLine();
      } else {
        gateError.style.display = 'block';
      }
    }

    codeSubmit?.addEventListener('click', tryUnlock);
    codeInput?.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryUnlock(); });

    window.addEventListener('load', showGateIfNeeded);
  </script>
  {% block body_extra %}{% endblock %}
</body>
</html>
